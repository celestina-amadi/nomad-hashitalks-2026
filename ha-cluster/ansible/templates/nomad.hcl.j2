# =============================================================================
# Nomad Server Configuration - {{ server_name }}
# Generated by Ansible
# =============================================================================

# Unique name for this node in the cluster
name = "{{ server_name }}"

# Directory where Nomad stores Raft state, allocation data, etc.
data_dir = "/opt/nomad/data"

# Listen on all network interfaces (0.0.0.0)
# The advertise block below tells other nodes which IP to use to reach us
bind_addr = "0.0.0.0"

# Advertise addresses - tells other nodes how to reach THIS server
# Use the private IP so cluster traffic stays on the internal network
advertise {
  http = "{{ private_ip }}:4646"   # API and Web UI
  rpc  = "{{ private_ip }}:4647"   # Remote procedure calls (job submissions, etc.)
  serf = "{{ private_ip }}:4648"   # Gossip protocol (cluster membership)
}

# Server configuration - makes this node a server (control plane)
server {
  enabled          = true   # This node participates in scheduling decisions
  bootstrap_expect = 3      # Wait for 3 servers before starting leader election

  # How to find the other servers in the cluster
  # Nomad will keep retrying until all servers are reachable
  server_join {
    retry_join = [{% for host in groups['nomad_servers'] %}"{{ hostvars[host]['private_ip'] }}:4648"{% if not loop.last %}, {% endif %}{% endfor %}]
  }
}

# Client configuration - also enables this node to run workloads
# In small clusters, servers can double as clients (workers)
client {
  enabled = true   # This node can also run jobs (not just schedule them)
  servers = [{% for host in groups['nomad_servers'] %}"{{ hostvars[host]['private_ip'] }}:4647"{% if not loop.last %}, {% endif %}{% endfor %}]
}

# Datacenter and region labels for job placement constraints
datacenter = "dc1"      # Logical datacenter name
region     = "global"   # Logical region name

# Logging configuration
log_level = "INFO"                       # Log verbosity: TRACE, DEBUG, INFO, WARN, ERR
log_file  = "/var/log/nomad/nomad.log"   # Write logs to file (in addition to stdout)

# Enable the web UI (accessible at http://<server-ip>:4646)
ui {
  enabled = true
}

# Metrics for monitoring with Prometheus/Grafana
telemetry {
  prometheus_metrics         = true   # Expose metrics at /v1/metrics?format=prometheus
  disable_hostname           = true   # Cleaner metric names without hostname prefix
  publish_allocation_metrics = true   # Metrics about running allocations (jobs)
  publish_node_metrics       = true   # Metrics about node health and resources
}
